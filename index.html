<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Sistem Kontrol Antrian PLN Purwakarta</title>

<style>
html, body { height:100%; }
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#125d72,#14a2ba);
  display:flex;
  flex-direction:column;
}

.header{
  display:flex;
  align-items:center;
  padding:14px 20px;
  background:white;
  box-shadow:0 4px 10px rgba(0,0,0,.15);
}

.header img{ height:45px; margin-right:12px; }

.main{
  flex:1;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
}

.nomor{
  font-size:clamp(90px,20vw,140px);
  font-weight:bold;
  margin:20px 0;
}

.buttons{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
  justify-content:center;
}

.btn{
  width:85px;
  height:85px;
  border-radius:50%;
  border:none;
  cursor:pointer;
  color:white;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  font-size:13px;
  box-shadow:0 10px 20px rgba(0,0,0,.25);
}

.btn span{ font-size:26px; margin-bottom:4px; }

.play{ background:#ec4899; }
.next{ background:#f59e0b; }
.setting{ background:#14a2ba; }
.info{ background:#22c55e; }

.disabled{
  pointer-events:none;
  opacity:.4;
}

.footer{
  background:white;
  padding:8px;
  text-align:center;
  font-size:13px;
}
</style>
</head>

<body>

<div class="header">
<img src="https://upload.wikimedia.org/wikipedia/commons/9/97/Logo_PLN.png">
<h2>SISTEM ANTRIAN PLN PURWAKARTA</h2>
</div>

<div class="main">

<div class="nomor" id="nomor">-</div>

<div class="buttons">
<button class="btn play" onclick="panggil()"><span>▶️</span>Panggil</button>
<button class="btn next" onclick="lanjut()"><span>⏭</span>Lanjut</button>
</div>

<div class="buttons" style="margin-top:20px;">
<button class="btn setting" onclick="setting()"><span>⚙️</span>Setting</button>
<button class="btn info" onclick="info()"><span>ℹ️</span>Info</button>
</div>

</div>

<div class="footer">PLN Purwakarta • Sistem Antrian Digital</div>

<audio id="belAudio" preload="auto">
<source src="BEL.mp4" type="audio/mp4">
</audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

/* FIREBASE */
const firebaseConfig={
 apiKey:"AIzaSyBjyq3YZUXhkufKELDGknIl240rA1pNai4",
 authDomain:"sistem-antrian-pln-pwk-kota.firebaseapp.com",
 databaseURL:"https://sistem-antrian-pln-pwk-kota-default-rtdb.asia-southeast1.firebasedatabase.app"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const nomorRef=ref(db,"system/antrian/current");
const layarRef=ref(db,"system/layar");
const pinRef=ref(db,"system/config/adminPin");

/* STATE */
let nomor=0;
let sedangMain=false;
let bolehKontrol=false;

const nomorEl=document.getElementById("nomor");
const bel=document.getElementById("belAudio");

/* UTIL */
function lockUI(lock){
 document.querySelectorAll("button").forEach(b=>{
  if(lock) b.classList.add("disabled");
  else b.classList.remove("disabled");
 });
}

function refresh(){
 nomorEl.innerText=nomor===0?"-":nomor.toString().padStart(3,'0');
}

function delay(ms){
 return new Promise(r=>setTimeout(r,ms));
}

function playBel(){
 return new Promise(resolve=>{
  bel.pause();
  bel.currentTime=0;
  bel.onended=resolve;
  bel.onerror=resolve;
  bel.play().catch(resolve);
 });
}

function speak(text,lang){
 return new Promise(resolve=>{
  const u=new SpeechSynthesisUtterance(text);
  u.lang=lang;
  u.rate=0.95;
  u.onend=resolve;
  u.onerror=resolve;
  speechSynthesis.speak(u);
 });
}

/* ENGINE PANGGIL */
async function enginePanggil(){

 if(!bolehKontrol || nomor===0 || sedangMain) return;

 sedangMain=true;
 lockUI(true);
 speechSynthesis.cancel();

 /* estimasi durasi total */
 const estimasiDurasi=15000;

 await set(layarRef,{
  nomor:nomor.toString().padStart(3,'0'),
  show:true,
  updatedAt:Date.now(),
  durasi:estimasiDurasi
 });

 await playBel();
 await delay(300);

 await speak("Nomor antrian "+nomor+", silakan menuju loket pelayanan","id-ID");
 await delay(300);

 await speak("Queue number "+nomor+", please proceed to the service counter","en-US");

 sedangMain=false;
 lockUI(false);
}

/* ACTION */
window.panggil=function(){
 enginePanggil();
};

window.lanjut=async function(){
 if(!bolehKontrol || sedangMain) return;
 nomor++;
 await set(nomorRef,nomor);
 refresh();
 enginePanggil();
};

window.setting=async function(){
 if(!bolehKontrol || sedangMain) return;
 const awal=prompt("Masukkan nomor awal:",nomor||1);
 if(awal!==null && !isNaN(awal)){
  nomor=Number(awal);
  await set(nomorRef,nomor);
  refresh();
 }
};

window.info=function(){
 alert("SISTEM ANTRIAN PLN PURWAKARTA\nVersi Stabil Upgrade");
};

/* SYNC */
onValue(nomorRef,snap=>{
 if(snap.exists()){
  nomor=snap.val();
  refresh();
 }
});

/* LOGIN PIN */
async function cekPIN(){
 const pin=prompt("Masukkan PIN Admin:");
 const snap=await get(pinRef);

 if(!snap.exists() || pin!==snap.val()){
  alert("PIN salah!");
  lockUI(true);
 }else{
  bolehKontrol=true;
  lockUI(false);
 }
}
cekPIN();

/* UNLOCK AUDIO */
document.body.addEventListener("click",()=>{
 bel.play().then(()=>bel.pause()).catch(()=>{});
 speechSynthesis.speak(new SpeechSynthesisUtterance(" "));
},{once:true});

refresh();
</script>

</body>
</html>
